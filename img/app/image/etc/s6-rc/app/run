#!/bin/execlineb -WP
# SPDX-License-Identifier: EUPL-1.2+
# SPDX-FileCopyrightText: 2021, 2024-2025 Alyssa Ross <hi@alyssa.is>

export TMPDIR /run

export HOME /home/user
cd /home/user

if { /etc/mdev/wait virtiofs0 }

foreground {
  redirfd -r 0 /run/virtiofs/virtiofs0/config/type
  withstdinas -E type
  case $type {
    appimage {
      if { modprobe fuse }
      s6-setuidgid user
      export LD_LIBRARY_PATH /lib64
      /run/virtiofs/virtiofs0/config/run
    }
    flatpak {
      s6-envdir -fnL /run/virtiofs/virtiofs0/config/params
      multisubstitute {
        importas -iu id id
        importas -iu arch arch
        importas -iu branch branch
        importas -iu commit commit
        importas -iu runtime_commit runtime-commit
      }
      flatpak run --installation=virtiofs --arch=${arch} --branch=${branch}
        --commit=${commit} --runtime-commit=${runtime_commit} $id
    }
    nix {
      if {
	mount -t overlay
	  -o ro,lowerdir=/nix/store:/run/virtiofs/virtiofs0/config/nix/store
	  store /nix/store
      }

      s6-setuidgid user
      /run/virtiofs/virtiofs0/config/run
    }
  }
  fdmove -c 1 2
  echo "Unknown app type: ${type}"
}

s6-linux-init-shutdown -p now
