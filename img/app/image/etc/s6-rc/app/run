#!/bin/execlineb -WP
# SPDX-License-Identifier: EUPL-1.2+
# SPDX-FileCopyrightText: 2021, 2024-2025 Alyssa Ross <hi@alyssa.is>

export TMPDIR /run

if { /etc/mdev/wait virtiofs-host }

if { install -do user -g user /host/disk/home }
export HOME /host/disk/home
cd /host/disk/home

foreground {
  redirfd -r 0 /host/config/type
  withstdinas -E type
  case $type {
    appimage {
      if { modprobe loop }
      if {
        backtick -E offset { /host/config/run --appimage-offset }
        mount -o offset=${offset},nodev /host/config/run /mnt
      }
      s6-setuidgid user
      export APPIMAGE /host/config/run
      export APPDIR /mnt
      export ARGV0 /mnt/AppRun
      export LD_LIBRARY_PATH /lib64
      /mnt/AppRun
    }
    flatpak {
      s6-envdir -fnL /host/config/params
      s6-setuidgid user
      multisubstitute {
        importas -iu id id
        importas -iu arch arch
        importas -iu branch branch
        importas -iu commit commit
        importas -iu runtime_commit runtime-commit
      }
      flatpak run --installation=virtiofs --arch=${arch} --branch=${branch}
        --commit=${commit} --runtime-commit=${runtime_commit} $id
    }
    nix {
      if {
	mount -t overlay
	  -o ro,nosuid,nodev,lowerdir=/nix/store:/host/config/nix/store
	  store /nix/store
      }

      s6-setuidgid user
      /host/config/run
    }
  }
  fdmove -c 1 2
  echo "Unknown app type: ${type}"
}

s6-linux-init-shutdown -p now
