#!/bin/execlineb -P
# SPDX-License-Identifier: EUPL-1.2
# SPDX-FileCopyrightText: 2021 Alyssa Ross <hi@alyssa.is>

# Run from mdev.conf to check whether a partition that has appeared is
# the EFI System Partition.  If it is, link it as /dev/esp, and
# send a notification through the /dev/esp.poll fifo.

importas -iu MDEV MDEV

if {
  pipeline { lsblk -lnpo PARTUUID $MDEV }

  # Convert the UUID to UCS-2 so that it can be compared with the EFI
  # variable.  Busybox awk does not support inserting null bytes, so
  # we use line feeds instead and then convert them to null bytes with
  # tr.
  pipeline {
    awk "{
      gsub(\".\", \"&\\n\")
      printf \"\\006\\n\\n\\n%s\\n\\n\", $0
    }"
  }
  pipeline { tr "\\n" "\\0" }

  diff -aiq - /sys/firmware/efi/efivars/LoaderDevicePartUUID-4a67b082-0a4c-41cf-b6c7-440b29bb8c4f
}

foreground {
  redirfd -w 2 /dev/null
  ln -s $MDEV /dev/esp
}

redirfd -w -nb 1 /dev/esp.poll echo
