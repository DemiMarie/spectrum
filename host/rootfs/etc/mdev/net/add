#!/bin/execlineb -P
# SPDX-License-Identifier: EUPL-1.2+
# SPDX-FileCopyrightText: 2021 Alyssa Ross <hi@alyssa.is>

# Assign the whole IOMMU group containing this device to the network
# VM.

if { modprobe vfio-pci }

importas -i devpath DEVPATH

foreground {
  pipeline { ls -1 /sys${devpath}/iommu_group/devices }
  forstdin -pE device
  foreground {
    redirfd -w 2 /dev/null
    redirfd -w 1 /sys/bus/pci/devices/${device}/driver/unbind
    printf "%s" $device
  }
  foreground {
    redirfd -w 1 /sys/bus/pci/devices/${device}/driver_override
    printf vfio-pci
  }
  redirfd -w 1 /sys/bus/pci/drivers/vfio-pci/bind
  printf "%s" $device
}

assign-devices
