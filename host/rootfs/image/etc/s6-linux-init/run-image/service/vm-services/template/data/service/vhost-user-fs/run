#!/bin/execlineb -WS1
# SPDX-License-Identifier: EUPL-1.2+
# SPDX-FileCopyrightText: 2021-2025 Alyssa Ross <hi@alyssa.is>

s6-ipcserver-socketbinder -a 0700 -B env/virtiofsd.sock

if { fdmove 1 3 echo }
fdmove -c 3 0
redirfd -r 0 /dev/null

export TMPDIR /run

importas -i VM VM

nsenter --mount=${VM}/mount
unshare -U --map-user 1000 --map-group 1000 --uts --ipc --cgroup

virtiofsd --fd 3 --shared-dir ${VM}/fs
