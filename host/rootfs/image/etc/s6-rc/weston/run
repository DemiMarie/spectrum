#!/bin/execlineb -P
# SPDX-License-Identifier: EUPL-1.2+
# SPDX-FileCopyrightText: 2021, 2025 Alyssa Ross <hi@alyssa.is>

importas -Siu WAYLAND_DISPLAY

piperw 4 3
background {
  fdclose 3

  if {
    fdmove -c 0 4
    redirfd -w 1 /dev/null
    head -c 1
  }
  fdclose 4

  if { chmod -- 0770 $WAYLAND_DISPLAY }
  if { chgrp -- wayland $WAYLAND_DISPLAY }

  fdmove -c 1 5
  echo
}
fdclose 4
fdclose 5

# Workaround for
# https://gitlab.freedesktop.org/wayland/weston/-/merge_requests/1911
if { mkdir -p -m 0700 /run/user/0 }

backtick USER { id -un }
backtick HOME {
  importas -i user USER
  homeof $user
}

if { install -do wayland -g wayland -m 0770 /run/wayland }
if { chown wayland /dev/tty0 /dev/tty1 }
redirfd -r 0 /dev/tty1

importas -i home HOME
cd $home
if { udevadm wait /dev/dri/card0 }
unshare --cgroup --ipc --uts
s6-setuidgid wayland
weston -S $WAYLAND_DISPLAY
