#!/bin/execlineb -W
# SPDX-License-Identifier: EUPL-1.2+
# SPDX-FileCopyrightText: 2025 Alyssa Ross <hi@alyssa.is>

backtick -D "" uuid {
  importas -Siu 1
  blkid -o value -s UUID -- $1
}

if {
  multisubstitute {
    importas -Siu 0
    importas -Siu 1
    importas -Siu uuid
  }

  case $uuid {
    "" {
      if {
        fdmove -c 1 2
        printf "%s: '%s' does not have a UUID\n" $0 $1
      }
      exit 1
    }
  }

  mount -m -t btrfs -o nosuid,nodev,noexec,nosymfollow -- $1 /media/${uuid}
}

importas -Siu uuid

foreground {
  if -t { test -d /media/${uuid}/Spectrum/data/spectrum/storage }
  find /media/${uuid}/Spectrum/data/spectrum/storage
    -mindepth 1
    -maxdepth 1
    -name tmp.*
    -exec rm -rf -- {} ;
}

printf "%s\n" /media/${uuid}
