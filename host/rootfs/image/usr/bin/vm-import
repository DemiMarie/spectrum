#!/bin/execlineb -S2
# SPDX-License-Identifier: EUPL-1.2+
# SPDX-FileCopyrightText: 2023-2024 Alyssa Ross <hi@alyssa.is>

cd $2
elglob -0 names *

forx -po0 -E name { $names }

backtick -E id {
  backtick -E dir { mktemp -d /run/vm/by-id/XXXXXX }
  basename -- $dir
}
if { useradd -P /run -Urd / -s /bin/nologin gpu-${id} }

if { ln -s -- /run/vm/by-id/${id} /run/vm/by-name/${1}.${name} }
if { ln -s -- ${2}/${name} /run/vm/by-id/${id}/config }
if { ln -s -- /run/service/vmm/instance/${id} /run/vm/by-id/${id}/service }

if { create-vm-dependencies $id }

s6-instance-create -- /run/service/vmm $id
