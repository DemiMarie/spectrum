#!/bin/execlineb -S1
# SPDX-License-Identifier: EUPL-1.2+
# SPDX-FileCopyrightText: 2024-2025 Alyssa Ross <hi@alyssa.is>

if {
  mkdir -p
    /run/doc/${1}/doc
    /run/fs/${1}/config
    /run/fs/${1}/doc
    /run/vm/by-id/${1}/ns
}
if { mount --make-private --rbind /run/vm/by-id/${1}/ns /run/vm/by-id/${1}/ns }
if { touch /run/vm/by-id/${1}/ns/mnt /run/vm/by-id/${1}/ns/user }

if {
  redirfd -r 3 /run/vm/by-id/${1}/config

  s6-envuidgid fs
  s6-applyuidgid -Uzu 0

  unshare -S0 --propagation=slave
    --map-users 0:1000:1 --map-users 1:1:999 --map-users 1001:1001:4294966294
    --map-groups 0:1000:1 --map-groups 1:1:999 --map-groups 1001:1001:4294966294
    --mount=/run/vm/by-id/${1}/ns/mnt
    --user=/run/vm/by-id/${1}/ns/user

  # The VM should not be able to write directly into a tmpfs, and the host
  # should be able to assume there are no untrusted symlinks there, but there
  # can be writable block-based bind mounted subdirectories.

  # Needs to be shared so that additional mounts under config/ (e.g. from
  # mount-flatpak) will be propagated into the virtiofsd sandbox.
  if { mount --make-shared --rbind -o nofail /proc/self/fd/3/fs /run/fs/${1}/config }
  if { mount --rbind -o ro /run/fs/${1} /run/fs/${1} }

  # Needs to be shared so that when xdg-document-portal mounts its fuse
  # filesystem at /run/doc/${1}/doc, it will propagate to /run/fs/${1}/doc.
  if { mount --make-shared --rbind /run/doc/${1} /run/doc/${1} }
  mount --rbind /run/doc/${1}/doc /run/fs/${1}/doc
}

if { s6-instance-create /run/service/vm-services $1 }
elglob -0 services /run/service/vm-services/instance/${1}/services/*
forx -pE service { $services }
s6-svwait -U $service
